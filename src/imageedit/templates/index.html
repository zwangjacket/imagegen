<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ImageGen Studio</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
  <!-- Messages Overlay -->
  <div class="messages">
    {% if status_message %}
    <p class="status">{{ status_message }}</p>
    {% endif %}
    {% if error_message %}
    <p class="error">{{ error_message }}</p>
    {% endif %}
  </div>

  <!-- Sidebar: Configuration -->
  <aside>
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <h1>ImageGen</h1>
      <button id="theme-toggle" class="theme-toggle" title="Toggle Theme" type="button">
        ðŸŒ—
      </button>
    </div>

    <form method="post" id="main-form" class="editor-layout">
      <div class="control-group">
        <label for="prompt-name">Prompt Name</label>
        <input id="prompt-name" name="prompt_name" list="prompt-options" placeholder="e.g. cyborg_ninja"
          value="{{ selected_prompt }}" autocomplete="off">
        <datalist id="prompt-options">
          {% for prompt in prompt_names %}
          <option value="{{ prompt }}"></option>
          {% endfor %}
        </datalist>
      </div>

      <div class="control-group">
        <label for="model-name">AI Model</label>
        <select id="model-name" name="model_name">
          {% for model in model_names %}
          <option value="{{ model }}" {% if model==selected_model %}selected{% endif %}>{{ model }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="control-group">
        <label for="image-size-preset">Dimensions / Preset</label>
        <select id="image-size-preset" name="image_size_preset">
          {% for size in allowed_sizes %}
          <option value="{{ size }}" {% if size==image_size_value %}selected{% endif %}>{{ size }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="control-group">
        <label for="style-name">Style Modifier</label>
        <input id="style-name" name="style_name" list="style-options" placeholder="Search styles..."
          value="{{ selected_style }}">
        <datalist id="style-options">
          {% for style in style_names %}
          <option value="{{ style }}"></option>
          {% endfor %}
        </datalist>
      </div>

      {% if supports_image_urls %}
      <div class="control-group" id="image-urls-group">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 5px;">
          <label for="image-urls" style="margin-bottom:0;">Source Image URLs</label>
          <button type="button" id="upload-image-btn" class="secondary"
            style="font-size:0.75rem; padding:0.25rem 0.5rem;">Upload Local</button>
        </div>
        <textarea id="image-urls" name="image_urls" rows="3" placeholder="https://...">{{ image_urls_text }}</textarea>
        <input type="file" id="local-image-upload" accept="image/*" style="display:none;">
      </div>
      {% endif %}

      <div class="control-group">
        <label class="checkbox-label" style="display:flex;">
          <input type="hidden" name="include_prompt_metadata" value="off">
          <input type="checkbox" name="include_prompt_metadata" value="on" {% if include_prompt_metadata %}checked{%
            endif %}>
          <span>Save Prompt in EXIF Data</span>
        </label>
      </div>

      <div class="button-row">
        <button type="submit" name="action" value="load">Load</button>
        <button type="submit" name="action" value="save">Save</button>
      </div>
      <div class="button-row">
        <button type="submit" name="action" value="duplicate">Duplicate</button>
        <button type="submit" name="action" value="delete" class="danger"
          data-confirm="Delete this prompt permanently?">Delete</button>
      </div>

      <!-- Hidden button for style append logic -->
      <button type="submit" name="action" value="append_style" id="append-style-button"
        style="display:none;">Append</button>
    </form>
  </aside>

  <!-- Main: Editor & Gallery -->
  <main>
    <!-- Prompt Area -->
    <div class="prompt-container">
      <div style="display:flex; justify-content:space-between; align-items:flex-end;">
        <label for="prompt-text">PROMPT TEXT</label>
        <button class="primary" type="submit" form="main-form" name="action" value="run">
          <span>Generate Image</span>
          <span style="font-size: 1.2em;">&rarr;</span>
        </button>
      </div>
      <textarea form="main-form" id="prompt-text" name="prompt_text" spellcheck="true"
        placeholder="Describe the image you want to generate...">{{ prompt_text }}</textarea>
    </div>

    <!-- Generated Results (Immediate) -->
    {% if generated_paths %}
    <section class="run-results">
      <h3>Generated Results</h3>
      <div class="gallery" style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));">
        {% for entry in asset_entries %}
        <div class="asset-card">
          <a href="{{ url_for(asset_route, filename=entry.filename) }}" target="_blank">
            <img src="{{ url_for(asset_route, filename=entry.filename) }}" loading="lazy">
          </a>
          <div class="asset-meta">
            <div class="asset-filename">{{ entry.display }}</div>
            <form method="post" class="asset-actions">
              <input type="hidden" name="asset_filename" value="{{ entry.filename }}">
              <!-- pass through state to keep UI consistent -->
              <input type="hidden" name="prompt_name" value="{{ selected_prompt }}">
              <input type="hidden" name="model_name" value="{{ selected_model }}">
              <input type="hidden" name="prompt_text" value="{{ prompt_text }}">
              <button type="submit" name="action" value="asset_load">Use Params</button>
              <button type="submit" name="action" value="asset_delete" class="danger"
                data-confirm="Delete this asset?">Delete</button>
            </form>
          </div>
        </div>
        {% endfor %}
      </div>
    </section>
    {% endif %}

    <!-- Asset Library -->
    <section>
      <div class="gallery-header">
        <h3>Library ({{ asset_count }})</h3>
        <form method="get" id="gallery-controls" style="display:flex; gap:1rem; align-items:center;">
          <input type="hidden" name="prompt" value="{{ selected_prompt }}">
          <div style="display:flex; align-items:center; gap:0.5rem;">
            <label for="gallery-width">Cols</label>
            <select id="gallery-width" name="gallery_width" style="width:auto; padding:0.25rem;">
              {% for width in range(1, 6) %}
              <option value="{{ width }}" {% if width==gallery_width %}selected{% endif %}>{{ width }}</option>
              {% endfor %}
            </select>
          </div>
        </form>
      </div>

      <div class="gallery" style="grid-template-columns: repeat({{ gallery_width }}, 1fr);">
        {% for entry in gallery_entries %}
        <div class="asset-card">
          <a href="{{ url_for(asset_route, filename=entry.filename) }}" target="_blank">
            <img src="{{ url_for(asset_route, filename=entry.filename) }}" loading="lazy">
          </a>
          <div class="asset-meta">
            <div class="asset-filename">{{ entry.display }}</div>
            <form method="post" class="asset-actions">
              <input type="hidden" name="asset_filename" value="{{ entry.filename }}">
              <input type="hidden" name="prompt_name" value="{{ selected_prompt }}">
              <input type="hidden" name="model_name" value="{{ selected_model }}">
              <button type="submit" name="action" value="asset_load">Load</button>
              <button type="submit" name="action" value="asset_delete" class="danger"
                data-confirm="Delete this asset?">Delete</button>
            </form>
          </div>
        </div>
        {% endfor %}
      </div>
    </section>
  </main>
  <script src="{{ url_for('static', filename='script.js') }}"></script>
</body>

</html>