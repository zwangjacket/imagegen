<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ImageGen Studio</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
  <!-- Messages Overlay -->
  <div class="messages">
    {% if status_message %}
    <p class="status">{{ status_message }}</p>
    {% endif %}
    {% if error_message %}
    <p class="error">{{ error_message }}</p>
    {% endif %}
  </div>

  <div class="container">
    <!-- Sidebar: Configuration -->
    <aside>
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <h1>ImageGen</h1>
        <button id="theme-toggle" class="theme-toggle" title="Toggle the site theme." type="button">
          ðŸŒ—
        </button>
      </div>



      <form method="post" id="main-form" class="editor-layout">
        <div class="control-group" data-group="prompt">
          <label for="prompt-name-preset">Prompt Name</label>
          <input id="prompt-name-preset" name="prompt_name" type="text" list="prompt-options"
            placeholder="e.g. cyborg_ninja" value="{{ selected_prompt }}" autocomplete="off"
            title="Enter or select a prompt name.">
          <datalist id="prompt-options">
            {% for prompt in prompt_names %}
            <option value="{{ prompt }}"></option>
            {% endfor %}
          </datalist>
          <div class="button-row" style="margin-top: 2px;">
            <button type="button" id="load-prompt-btn" class="secondary" style="font-size:0.8rem;"
              title="(l) Load the prompt for editing.">Load Prompt</button>
            <button type="button" id="duplicate-prompt-btn" class="secondary"
              style="font-size:0.8rem;" title="(d) Duplicate the current prompt.">Duplicate</button>
          </div>
          <div class="button-row" style="margin-top: 5px;">
            <button type="button" id="save-prompt-btn" class="secondary" style="font-size:0.8rem;"
              title="(s) Save the current prompt text.">Save
              Prompt</button>
            <button type="button" id="delete-prompt-btn" class="danger" style="font-size:0.8rem;"
              title="Delete the selected prompt.">Delete
              Prompt</button>
          </div>
        </div>

        <div class="control-group">
          <label for="model-name">AI Model</label>
          <select id="model-name" name="model_name" title="(m) Choose the AI model.">
            {% for model in model_names %}
            <option value="{{ model }}" {% if model==selected_model %}selected{% endif %}>{{ model }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="control-group" data-group="size">
          <label for="image-size-preset">Dimensions / Preset</label>
          <select id="image-size-preset" name="image_size_preset" title="(D) Choose the dimensions preset.">
            {% for size in allowed_sizes %}
            <option value="{{ size }}" {% if size==image_size_value %}selected{% endif %}>{{ size }}</option>
            {% endfor %}
          </select>
        </div>

        <details class="control-group" data-group="style">
          <summary title="Expand style modifier controls.">Style Modifier</summary>
          <select id="style-name-preset" name="style_name_preset" title="(S) Choose a style preset.">
            <option value="" {% if not selected_style in style_names %}selected{% endif %}>-- None / Custom --
            </option>
            {% for style in style_names %}
            <option value="{{ style }}" {% if style==selected_style %}selected{% endif %}>{{ style }}</option>
            {% endfor %}
          </select>
          <textarea id="style-name-custom" name="style_name_custom" rows="3"
            title="Edit the style prompt text."
            placeholder="Or type custom style...">{% if selected_style not in style_names %}{{ selected_style }}{% endif %}</textarea>
          <button type="button" id="insert-style-btn" class="secondary" style="font-size:0.8rem; margin-top:2px;"
            title="(I) Append the style block to the prompt.">Insert
            to Prompt</button>
          <div class="button-row" style="margin-top: 0.5rem;">
            <button type="button" id="save-style-btn" class="secondary"
              title="Save the current style text.">Save Style</button>
            <button type="button" id="delete-style-btn" class="danger"
              title="Delete the selected style.">Delete Style</button>
          </div>
        </details>

        <div class="control-group" id="image-urls-group" {% if not supports_image_urls %}style="display:none;" {% endif
          %}>
          <div style="margin-bottom: 5px;">
            <label for="image-urls" style="margin-bottom:0.25rem; display:block;">Source Image URLs</label>
            <div class="image-url-controls">
              <button type="button" id="upload-image-btn" class="secondary"
                title="Upload a local image and add it as a source URL.">Upload Local Image</button>
              <label class="toggle-switch" title="Toggle previews for source images.">
                <input type="checkbox" id="toggle-image-preview" title="Toggle previews for source images.">
                <span class="slider round"></span>
                <span class="label-text">Preview</span>
              </label>
            </div>
          </div>
          <div id="image-url-input-container">
            <textarea id="image-urls" name="image_urls" rows="3" placeholder="https://..."
              title="Enter one source image URL per line."
              spellcheck="false">{{ image_urls_text }}</textarea>
          </div>
          <div id="image-preview-container" class="image-preview-grid" style="display:none;">
            <!-- Previews will be injected here -->
          </div>
          <input type="file" id="local-image-upload" accept="image/*" style="display:none;"
            title="Choose a local image to upload.">
        </div>

        <div class="control-group">
          <label class="checkbox-label" style="display:flex;">
            <input type="hidden" name="include_prompt_metadata" value="off">
            <input type="checkbox" name="include_prompt_metadata" value="on" {% if include_prompt_metadata %}checked{%
              endif %} title="Include prompt metadata in the image EXIF.">
            <span>Save Prompt in EXIF Data</span>
            <span class="info-icon" title="Embeds the model name and prompt text into the image file's metadata tags."
              data-tooltip="Embeds the model name and prompt text into the image file's metadata tags.">?</span>
          </label>
        </div>

        <!-- Hidden button for style append logic -->
        <button type="submit" name="action" value="append_style" id="append-style-button"
          style="display:none;">Append</button>
      </form>

      <!-- Attribution -->
      <div style="display:flex; gap:0.5rem; margin-top: auto;">
        <a href="https://github.com/zoec98/imagegen" target="_blank" rel="noopener noreferrer" class="repo-link"
          title="Open the imagegen repository." style="flex:1 1 50%; text-align:center;">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style="vertical-align: text-bottom;">
            <path
              d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z" />
          </svg>
          zoec
        </a>
        <a href="https://github.com/zwangjacket/imagegen" target="_blank" rel="noopener noreferrer" class="repo-link"
          title="Open the Zwangjacket imagegen repository." style="flex:1 1 50%; text-align:center;">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style="vertical-align: text-bottom;">
            <path
              d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z" />
          </svg>
          Zwangjacket
        </a>
      </div>
    </aside>

    <!-- Main: Editor & Gallery -->
    <main>
      <!-- Prompt Area -->
      <div class="prompt-container">
        <div style="display:flex; justify-content:space-between; align-items:flex-end;">
          <label for="prompt-text">
            PROMPT TEXT
            <a href="https://fal.ai/dashboard/billing" target="_blank" class="usage-link"
              title="Open fal.ai usage and billing.">(Check Usage)</a>
          </label>
          <button class="primary" type="submit" form="main-form" name="action" value="run"
            title="(g) Generate an image from the current prompt.">
            <span>Generate Image</span>
            <span style="font-size: 1.2em;">&rarr;</span>
          </button>
        </div>
        <textarea form="main-form" id="prompt-text" name="prompt_text" spellcheck="true"
          title="Edit the main prompt text."
          placeholder="Describe the image you want to generate...">{{ prompt_text }}</textarea>
      </div>

      <!-- Generated Results (Immediate) -->
      {% if generated_paths %}
      <section class="run-results">
        <h3>Generated Results</h3>
        <div class="gallery" style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));">
          {% for entry in asset_entries %}
          <div class="asset-card">
            <a href="{{ url_for(asset_route, filename=entry.filename) }}" target="_blank"
              title="Open the generated asset in a new tab.">
              <img src="{{ url_for(asset_route, filename=entry.filename) }}" loading="lazy">
            </a>
            <div class="asset-meta">
              <div class="asset-filename">{{ entry.display }}</div>
              <form method="post" class="asset-actions">
                <input type="hidden" name="asset_filename" value="{{ entry.filename }}">
                <!-- pass through state to keep UI consistent -->
                <input type="hidden" name="prompt_name" value="{{ selected_prompt }}">
                <input type="hidden" name="model_name" value="{{ selected_model }}">
                <input type="hidden" name="prompt_text" value="{{ prompt_text }}">
                <button type="submit" name="action" value="asset_load"
                  title="Load this asset's prompt parameters.">Use Params</button>
                <button type="submit" name="action" value="asset_delete" class="danger"
                  data-confirm="Delete this asset?" title="Delete this generated asset.">Delete</button>
              </form>
            </div>
          </div>
          {% endfor %}
        </div>
      </section>
      {% endif %}

      <!-- Asset Library -->
      <section>
        <div class="gallery-header">
          <h3>Library ({{ asset_count }})</h3>
          <form method="get" id="gallery-controls" style="display:flex; gap:1rem; align-items:center;">
            <input type="hidden" name="prompt" value="{{ selected_prompt }}">
            <div style="display:flex; align-items:center; gap:0.5rem;">
              <label for="gallery-width">Cols</label>
              <select id="gallery-width" name="gallery_width" style="width:auto; padding:0.25rem;"
                title="Choose how many columns to show.">
                {% for width in range(1, 6) %}
                <option value="{{ width }}" {% if width==gallery_width %}selected{% endif %}>{{ width }}</option>
                {% endfor %}
              </select>
            </div>
          </form>
        </div>

        <div class="gallery cols-{{ gallery_width }}">
          {% for entry in gallery_entries %}
          <div class="asset-card">
            <a href="{{ url_for(asset_route, filename=entry.filename) }}" target="_blank"
              title="Open the asset in a new tab.">
              <img src="{{ url_for(asset_route, filename=entry.filename) }}" loading="lazy">
            </a>
            <div class="asset-meta">
              <div class="asset-filename">{{ entry.display }}</div>
              <form method="post" class="asset-actions">
                <input type="hidden" name="asset_filename" value="{{ entry.filename }}">
                <input type="hidden" name="prompt_name" value="{{ selected_prompt }}">
                <input type="hidden" name="model_name" value="{{ selected_model }}">
                <button type="submit" name="action" value="asset_load"
                  title="Load this asset's prompt parameters.">Load</button>
                <button type="submit" name="action" value="asset_delete" class="danger"
                  data-confirm="Delete this asset?" title="Delete this asset from the library.">Delete</button>
              </form>
            </div>
          </div>
          {% endfor %}
        </div>
      </section>
    </main>
    <!-- Save Style Modal -->
    <div id="save-style-modal" class="modal-overlay">
      <div class="modal">
        <div class="modal-header">
          <h3>Save Style</h3>
        </div>
        <div class="modal-body">
          <label for="new-style-name" style="display:block; margin-bottom:0.5rem;">Style Name</label>
          <input type="text" id="new-style-name" placeholder="E.g., Cinematic Lighting" autocomplete="off"
            title="Enter a name for the style.">
        </div>
        <div class="modal-footer">
          <button type="button" id="cancel-style-btn" class="secondary"
            title="Cancel saving this style.">Cancel</button>
          <button type="button" id="confirm-save-style-btn" class="primary"
            title="Save this style to the styles library.">Save</button>
        </div>
      </div>
    </div>

    <!-- Keyboard Shortcuts Modal -->
    <div id="shortcuts-modal" class="modal-overlay">
      <div class="modal">
        <div class="modal-header">
          <h3>Keyboard Shortcuts</h3>
        </div>
        <div class="modal-body">
          <p>Press Esc or ? to close.</p>
          <p><strong>?</strong> Open shortcuts</p>
          <p><strong>l</strong> Load prompt</p>
          <p><strong>s</strong> Save prompt</p>
          <p><strong>d</strong> Duplicate prompt</p>
          <p><strong>g</strong> Generate image</p>
          <p><strong>p</strong> Focus prompt editor</p>
          <p><strong>m</strong> Focus model selector</p>
          <p><strong>D</strong> Focus dimensions selector</p>
          <p><strong>S</strong> Focus style selector</p>
          <p><strong>I</strong> Insert style to prompt</p>
        </div>
        <div class="modal-footer">
          <button type="button" id="close-shortcuts-btn" class="secondary"
            title="(Esc/?) Close the shortcuts help.">Close</button>
        </div>
      </div>
    </div>

    <!-- Delete Style Confirmation Modal -->
    <div id="delete-style-modal" class="modal-overlay">
      <div class="modal">
        <div class="modal-header">
          <h3>Delete Style</h3>
        </div>
        <div class="modal-body">
          <p>Are you sure you want to delete the style "<span id="delete-style-name-display"></span>"?</p>
        </div>
        <div class="modal-footer">
          <button type="button" id="cancel-delete-style-btn" class="secondary"
            title="Cancel deleting the style.">Cancel</button>
          <button type="button" id="confirm-delete-style-btn" class="danger"
            title="Delete this style permanently.">Yes, Delete</button>
        </div>
      </div>
    </div>

    <!-- Save Prompt Modal -->
    <div id="save-prompt-modal" class="modal-overlay">
      <div class="modal">
        <div class="modal-header">
          <h3>Save Prompt</h3>
        </div>
        <div class="modal-body">
          <label for="new-prompt-name" style="display:block; margin-bottom:0.5rem;">Prompt Name</label>
          <input type="text" id="new-prompt-name" placeholder="E.g., Starry Night landscape" autocomplete="off"
            title="Enter a name for the prompt.">
        </div>
        <div class="modal-footer">
          <button type="button" id="cancel-prompt-btn" class="secondary"
            title="Cancel saving the prompt.">Cancel</button>
          <button type="button" id="confirm-save-prompt-btn" class="primary"
            title="Save the prompt to the prompts folder.">Save</button>
        </div>
      </div>
    </div>

    <!-- Delete Prompt Confirmation Modal -->
    <div id="delete-prompt-modal" class="modal-overlay">
      <div class="modal">
        <div class="modal-header">
          <h3>Delete Prompt</h3>
        </div>
        <div class="modal-body">
          <p>Are you sure you want to delete the prompt "<span id="delete-prompt-name-display"></span>"?</p>
        </div>
        <div class="modal-footer">
          <button type="button" id="cancel-delete-prompt-btn" class="secondary"
            title="Cancel deleting the prompt.">Cancel</button>
          <button type="button" id="confirm-delete-prompt-btn" class="danger"
            title="Delete this prompt permanently.">Yes, Delete</button>
        </div>
      </div>
    </div>


  </div> <!-- container -->

  <script src="{{ url_for('static', filename='script.js') }}"></script>
</body>

</html>
